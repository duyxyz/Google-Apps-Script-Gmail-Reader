<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ứng dụng đọc Gmail Đơn giản</title>
  <style>
    /* Ẩn thanh cuộn cho toàn bộ trang */
    html { 
      overflow-y: hidden; 
      overflow-x: hidden; 
    } 
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      /* Nền trắng (Full width, không có "nền phía sau") */
      background-color: #fff; 
      color: #333;
      min-height: 100vh; 
      display: flex; 
      flex-direction: column;
    }

    .container {
      flex-grow: 1;
      /* Full width: Bỏ padding, margin và border */
      padding: 0; 
      width: 100%; 
      max-width: none; 
      margin: 0; 
      background-color: #fff;
      border: none; 
      box-sizing: border-box;
      display: flex; 
      flex-direction: column;
      min-height: 100vh;
    }

    /* --- LOGIN PAGE --- */
    #login-page {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
      background-color: #eee;
      height: 100vh; 
      flex-direction: column;
    }
    
    .pin-input-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 0 auto 10px; 
        width: fit-content;
    }

    .pin-input {
        width: 30px; 
        height: 40px;
        font-size: 24px;
        text-align: center;
        border: none;
        border-bottom: 3px solid #ccc;
        outline: none;
        transition: border-bottom-color 0.3s;
        background-color: transparent;
        color: #333;
        font-weight: bold;
        padding: 0;
        box-sizing: border-box;
    }

    .pin-input:focus {
        border-bottom-color: #dc3545;
    }

    .error-msg {
      color: red;
      font-size: 14px;
      display: none;
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
    }

    /* --- MAIN PAGE --- */
    #main-page {
      display: none; 
      flex-direction: column; 
      flex-grow: 1; 
    }

    /* Header (Tab và Controls) */
    .header-controls {
      /* Thêm padding ngang cho header */
      padding: 10px; 
      border-bottom: 1px solid #ccc;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between; 
      align-items: flex-end; 
      flex-wrap: wrap; 
      gap: 10px;
    }

    .tab-buttons button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
      margin-right: 5px;
    }
    .tab-buttons button.active {
      background: #fff;
      border-bottom: none;
      border-top: 2px solid #dc3545;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      align-items: center; 
      padding: 0;
    }
    
    .controls label, .controls input[type="checkbox"] {
        margin: 0;
        transform: translateY(0.5px); 
    }

    /* Limit Controls */
    .limit-controls {
        display: flex;
        align-items: stretch;
        border: 1px solid #ccc;
        border-radius: 4px; 
        overflow: hidden; 
        margin-right: 10px;
    }
    .limit-controls button {
        padding: 5px 10px; 
        line-height: 1; 
        background-color: #f0f0f0;
        color: #333;
        border: none;
        cursor: pointer;
        min-width: unset !important;
        font-weight: bold;
    }
    .limit-controls span {
        padding: 5px 10px; 
        line-height: 1; 
        font-weight: bold;
        background-color: #fff;
        min-width: 20px;
        text-align: center;
        box-sizing: border-box;
        border-left: 1px solid #ccc;
        border-right: 1px solid #ccc;
        pointer-events: none;
        font-size: 14px; 
    }

    /* Reload Button */
    .button {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 5px 8px; 
      gap: 6px; 
      border: none;
      background: #f21d31; 
      border-radius: 20px;
      cursor: pointer;
      box-sizing: border-box;
      min-width: 90px;
    }
    .lable {
      line-height: 1; 
      font-size: 15px;
      color: #ffffff; 
      letter-spacing: 1px;
    }
    .button:hover {
      background: #dc354552; 
    }
    .button.loading .svg-icon,
    .button:hover .svg-icon {
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(-360deg); }
    }


    /* Email list container */
    .email-list {
      flex-grow: 1; 
      flex-shrink: 1; 
      flex-basis: 0;
      margin-top: 0; 
      min-height: 100px; 
      /* Thêm padding ngang cho list */
      padding: 0 10px; 
      overflow-y: auto; 
      /* ẨN SCROLLBAR */
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .email-list::-webkit-scrollbar {
        display: none;
    }
    
    .email-list.with-border {
        border: none; 
    }

    .email-row {
      display: flex;
      padding: 10px 0; /* Padding đứng 10px, ngang 0 */
      border-bottom: 1px solid #eee;
      cursor: pointer;
      align-items: center;
    }
    .email-row:hover { background-color: #f0f0f0; }

    /* Tên người gửi (in đậm) */
    .email-row .subject { 
      font-weight: bold;
      margin-right: 10px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      flex-grow: 1;
      max-width: 30%; 
    }
    /* Chủ đề (văn bản thường) */
    .email-row .snippet { 
      color: #333; 
      font-size: 1em; 
      font-weight: normal; 
      flex-grow: 2;
      max-width: 60%; 
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    
    .email-row .date {
      min-width: 100px;
      text-align: right;
      font-size: 0.8em;
      color: #999;
    }
    .email-row.unread {
      background-color: #e6f7ff;
    }

    /* Popup */
    .popup {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: #fff;
      padding: 20px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto; 
      position: relative;
    }
    /* Ẩn scrollbar trong Popup */
    .popup-content::-webkit-scrollbar {
        display: none;
    }
    .popup-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
  </style>
</head>
<body>
  <div id="login-page">
    <div class="pin-input-container">
        <input type="password" class="pin-input" id="pin-1" maxlength="1" pattern="[0-9]*" inputmode="numeric" required autofocus data-index="1">
        <input type="password" class="pin-input" id="pin-2" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="2">
        <input type="password" class="pin-input" id="pin-3" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="3">
        <input type="password" class="pin-input" id="pin-4" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="4">
        <input type="password" class="pin-input" id="pin-5" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="5">
        <input type="password" class="pin-input" id="pin-6" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="6">
        <input type="password" class="pin-input" id="pin-7" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="7">
        <input type="password" class="pin-input" id="pin-8" maxlength="1" pattern="[0-9]*" inputmode="numeric" required data-index="8">
    </div>
    <p id="error" class="error-msg">Mã PIN không đúng!</p>
  </div>

  <div id="main-page" class="container">
    <div class="header-controls">
        <div class="tab-buttons">
          <button onclick="showTab('inbox', event)" class="active">Hòm thư</button>
        </div>

        <div class="controls">
          <label>Tải lại (10s):</label>
          <input type="checkbox" id="auto-reload-toggle">
          
          <div class="limit-controls">
              <button onclick="decreaseLimit()">-</button>
              <span id="current-limit">5</span>
              <button onclick="increaseLimit()">+</button>
          </div>
          
          <button class="button" id="reload-btn" onclick="manualReload()">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              viewBox="0 0 20 20"
              height="20"
              fill="none"
              class="svg-icon"
            >
              <g stroke-width="1.5" stroke-linecap="round" stroke="#ffffff"> 
                <path
                  d="m3.33337 10.8333c0 3.6819 2.98477 6.6667 6.66663 6.6667 3.682 0 6.6667-2.9848 6.6667-6.6667 0-3.68188-2.9847-6.66664-6.6667-6.66664-1.29938 0-2.51191.37174-3.5371 1.01468"
                ></path>
                <path
                  d="m7.69867 1.58163-1.44987 3.28435c-.18587.42104.00478.91303.42582 1.0989l3.28438 1.44986"
                ></path>
              </g>
            </svg>
            <span class="lable" id="reload-text">Load</span>
          </button>
          </div>
    </div>
    

    <div id="inbox" class="tab-content email-list">
      <div id="inbox-list"></div>
    </div>
  </div>

  <div id="email-popup" class="popup">
    <div class="popup-content">
      <div id="email-content" class="email-body"></div>
    </div>
  </div>

  <script>
    let currentTab = 'inbox';
    let inboxEmails = [];
    let autoReloadInterval = null;
    let currentLimit = 1; 
    const stepLimit = 1; 
    const minLimit = 1;
    const maxLimit = 50;

    // Hàm login mới, đọc PIN từ 8 ô
    async function login() {
      // 1. Lấy mã PIN từ 8 ô
      const pin = Array.from(document.querySelectorAll('.pin-input'))
        .map(input => input.value)
        .join('');

      const error = document.getElementById('error');
      error.style.display = 'none'; 

      if (pin.length !== 8) {
          error.textContent = 'Vui lòng nhập đủ 8 ký tự PIN.';
          error.style.display = 'block';
          return;
      }

      try {
        const isValid = await new Promise(resolve => google.script.run.withSuccessHandler(resolve).validatePin(pin));
        
        if (isValid) {
          const expiryDays = await new Promise(resolve => google.script.run.withSuccessHandler(resolve).getPinExpiryDays());
          const expiry = new Date();
          expiry.setDate(expiry.getDate() + expiryDays);
          localStorage.setItem('pin', pin);
          localStorage.setItem('pinExpiry', expiry.getTime());
          showMainPage(); 
        } else {
            error.textContent = 'Mã PIN không đúng!';
            error.style.display = 'block';
            // Xóa nội dung và focus lại ô đầu tiên khi đăng nhập thất bại
            document.getElementById('pin-1').focus();
            document.querySelectorAll('.pin-input').forEach(input => input.value = '');
        }
      } catch (e) {
        error.textContent = 'Đã xảy ra lỗi: ' + (e.message || 'Lỗi không xác định');
        error.style.display = 'block';
      } 
    }

    // Thiết lập logic tự động nhảy ô và tự động đăng nhập
    function setupPinInputs() {
        const inputs = document.querySelectorAll('.pin-input');
        
        inputs.forEach((input, index) => {
            // Xử lý input: Tự động nhảy ô
            input.addEventListener('input', (e) => {
                if (e.data && e.data.length > 1) {
                    e.target.value = e.data[0];
                }

                if (input.value.length === 1) {
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    } else {
                        login();
                    }
                }
            });

            // Xử lý backspace/delete: Tự động nhảy về ô trước
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && input.value === '' && index > 0) {
                    e.preventDefault();
                    inputs[index - 1].focus();
                    inputs[index - 1].value = '';
                }
            });
            
            // Xử lý Paste (tối ưu trải nghiệm)
            input.addEventListener('paste', (e) => {
                const pastedData = e.clipboardData.getData('text').trim();
                if (pastedData.length >= inputs.length - index) {
                    e.preventDefault();
                    for (let i = 0; i < inputs.length - index; i++) {
                        if (i < pastedData.length) {
                            inputs[index + i].value = pastedData[i];
                        }
                    }
                    login(); 
                }
            });
        });
    }

    function checkAutoLogin() {
      const saved = localStorage.getItem('pin');
      const expiry = localStorage.getItem('pinExpiry');
      if (saved && Date.now() < parseInt(expiry)) {
        google.script.run.withSuccessHandler(isValid => {
          if (isValid) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'flex'; 
            manualReload();
          }
        }).validatePin(saved);
      } else {
        document.getElementById('login-page').style.display = 'flex';
      }
    }

    async function showMainPage() {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-page').style.display = 'flex'; 
      await manualReload(); 
    }

    async function manualReload() {
      const btn = document.getElementById('reload-btn');
      const text = document.getElementById('reload-text');
      
      text.textContent = 'Đang tải'; 
      btn.disabled = true;
      btn.classList.add('loading'); 

      try {
        await loadAllEmails(); 
        loadEmails();
      } catch (e) {
        console.error("Lỗi khi tải email:", e);
        alert("Không thể tải email. Vui lòng thử lại.");
        loadEmails(); 
      } finally {
        text.textContent = `Load`;
        btn.disabled = false;
        btn.classList.remove('loading'); 
      }
    }

    async function loadAllEmails() {
      const savedPin = localStorage.getItem('pin');
      inboxEmails = await new Promise(resolve => 
        // Gọi hàm Apps Script của bạn
        google.script.run.withSuccessHandler(resolve).getAllEmailsWithHtml(currentLimit, savedPin)
      );
    }

    function showTab(tab, event) {
      currentTab = tab;
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.getElementById('inbox').style.display = 'block'; 
      document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadEmails();
    }

    function loadEmails() {
        const listContainer = document.getElementById('inbox-list');
        const emailListDiv = document.getElementById('inbox');
        listContainer.innerHTML = '';

        if (inboxEmails.length === 0) {
            emailListDiv.classList.remove('with-border');
            listContainer.innerHTML = '<div style="padding: 20px 10px; text-align: center; color: #666;">Không có email nào được tải. (Kiểm tra thiết lập lọc trong Apps Script).</div>';
        } else {
            emailListDiv.classList.add('with-border');
            inboxEmails.forEach(email => renderEmailRow(listContainer, email));
        }
    }

    function renderEmailRow(container, email) {
      const row = document.createElement('div');
      row.className = `email-row ${email.isUnread ? 'unread' : ''}`;
      row.onclick = () => showEmailPopup(email);

      // Tên người gửi (in đậm)
      const sender = document.createElement('span');
      sender.className = 'subject'; 
      sender.textContent = email.from || 'Người Gửi Không Rõ'; 
      row.appendChild(sender);

      // Chủ đề (văn bản thường)
      const subject = document.createElement('span');
      subject.className = 'snippet'; 
      subject.textContent = ` - ${email.subject}`; 
      row.appendChild(subject);
      
      const date = document.createElement('span');
      date.className = 'date';
      date.textContent = email.date;
      row.appendChild(date);
      
      container.appendChild(row);
    }

    async function showEmailPopup(email) {
      const content = document.getElementById('email-content');
      content.innerHTML = email.html || `<div>${email.snippet}</div><p style="color:#666;">Không tìm thấy nội dung HTML đầy đủ.</p>`;

      document.getElementById('email-popup').style.display = 'flex';
      
      if (email.isUnread) {
        const savedPin = localStorage.getItem('pin');
        await new Promise(resolve => google.script.run.withSuccessHandler(resolve).markAsRead(email.id, savedPin));
        email.isUnread = false;
        loadEmails();
      }
    }

    function closePopup() {
      document.getElementById('email-popup').style.display = 'none';
      document.getElementById('email-content').innerHTML = '';
    }

    // --- Limit Control Functions ---
    function updateLimitDisplay() {
        document.getElementById('current-limit').textContent = currentLimit;
    }

    function increaseLimit() {
        if (currentLimit < maxLimit) {
            currentLimit += stepLimit; 
            if (currentLimit > maxLimit) currentLimit = maxLimit; 
            updateLimitDisplay();
            manualReload(); 
        }
    }

    function decreaseLimit() {
        if (currentLimit > minLimit) {
            currentLimit -= stepLimit; 
            if (currentLimit < minLimit) currentLimit = minLimit; 
            updateLimitDisplay();
            manualReload(); 
        }
    }
    // --- End Limit Control Functions ---

    document.getElementById('auto-reload-toggle').addEventListener('change', function () {
      localStorage.setItem('autoReload', this.checked);
      if (this.checked) {
        manualReload();
        autoReloadInterval = setInterval(manualReload, 10000);
      } else clearInterval(autoReloadInterval);
    });

    window.onload = () => {
      checkAutoLogin();
      setupPinInputs();
      
      const saved = localStorage.getItem('autoReload') === 'true';
      document.getElementById('auto-reload-toggle').checked = saved;
      if (saved) autoReloadInterval = setInterval(manualReload, 10000);

      updateLimitDisplay();
    };

    // Thêm sự kiện đóng popup khi click ra ngoài
    document.getElementById('email-popup').addEventListener('click', e => {
      if (e.target === document.getElementById('email-popup')) closePopup();
    });

    // Xử lý phím Esc để đóng Popup
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closePopup();
    });
  </script>
</body>
</html>
